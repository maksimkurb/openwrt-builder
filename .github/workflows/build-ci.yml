name: Build and Publish OpenWRT Builder docker Image

env:
  DEFAULT_OPENWRT_VERSION: 'openwrt-24.10,openwrt-25.12'
  DEFAULT_ROUTER_CONFIG: 'glinet-mt6000'

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      openwrt_version_git_ref:
        description: 'OpenWRT version/branch (comma-separated, e.g., master,openwrt-24.10)'
        required: false
        default: 'openwrt-24.10'
      router:
        description: 'Router config (comma-separated, e.g., glinet-mt6000)'
        required: false
        default: 'glinet-mt6000'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        openwrt_version_git_ref: ${{ fromJSON(format('[%s]', format('"{0}"', join(split((github.event.inputs.openwrt_version_git_ref || env.DEFAULT_OPENWRT_VERSION), ','), '","')))) }}
        router: ${{ fromJSON(format('[%s]', format('"{0}"', join(split((github.event.inputs.router || env.DEFAULT_ROUTER_CONFIG), ','), '","')))) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build OpenWRT
        run: |
          docker build --build-arg OPENWRT_VERSION_GIT_REF="${{ matrix.openwrt_version_git_ref }}" --build-arg ROUTER_CONFIG="${{ matrix.router }}" -t "ghcr.io/${{ github.repository_owner }}/openwrt-builder:${{ matrix.openwrt_version_git_ref }}-${{ matrix.router }}" .

      - name: Login to GitHub Packages
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push Docker Image
        run: |
          docker push "ghcr.io/${{ github.repository_owner }}/openwrt-builder:${{ matrix.openwrt_version_git_ref }}-${{ matrix.router }}" 
